# 📘 多格式文档自动转 Markdown 的设计说明

## 一、为什么要做这个系统？

公司目前需要用到各种文件内容（Word、Excel、PDF、图片），并让 AI 进行分析、总结、结构化处理。之前 ai 医问对文件的处理太简单了比如 word，excel，pdf 等文件只解析里面的文字，把其它信息都丢掉，满足不了需要，这里需要单独做一个系统以后可以给任何项目使用。

但是问题是：

- 文件格式太多
- 文件内部结构差异巨大
- 文档中常常包含文字 + 表格 + 图片 + 截图
- OCR 在很多扫描件上根本识别不出内容
- AI 需要“文字版”才能理解内容

**所以我们必须先把所有文件统一转换成结构化的文字版本（Markdown 格式），才能进一步给 AI 使用。**

---

# 二、整体设计目标（非常简单）

这个系统做的事情只有一件：

> **无论给它什么格式的文件，它都能自动变成一份清晰、有结构、有内容的文字文档。**

包括：

- 原来的文字
- 表格内容
- 图片说明
- 图片里的文字
- 图片里的图示意义

一份文件 → 一份 Markdown → AI 可以完全理解。

---

# 三、为什么不能靠 OCR？

OCR 的问题：

- 图片模糊就识别不出来
- 扫描 PDF 很多是空白
- 手机拍的文件经常失败
- 表格结构容易错乱
- 字体小、压缩过、灰度低，都会识别失败

一句话：

> **OCR 对文件质量要求太高，实际业务里很难稳定使用。**

---

# 四、解决方案：完全依赖“视觉模型”（Vision LLM）

现代视觉模型（GPT-4.1、Qwen-VL、DeepSeek-Vision …）具备强能力：

- 能看懂模糊文字
- 能理解复杂表格
- 能理解流程图
- 能看懂截图里的按钮、界面
- 能理解图表、架构图
- 能把内容自动转成 Markdown 结构

也就是说：

> **它不再是简单识字，而是能像人一样“看懂文档”。**

因此，我们采用 **全视觉模型架构**：

✔ 稳定
✔ 准确
✔ 不依赖清晰图片
✔ 支持所有文档类型
✔ 可大规模处理

---

# 五、关键设计：AST（文档结构树）

为了让系统可扩展、可维护，我们需要一个“中间结构”，就像：

> **一个统一格式的“文档模型”——不论原文件是什么格式，都能被转成这个模型。**

我们把它叫做 **AST（文档结构树）**。

它就像拍电影前的“分镜头脚本”，告诉我们：

- 这里是标题
- 这里是段落
- 这里是一张表格
- 这里是一张图片
- 图片路径在这里
- 这个地方等待视觉模型来解释内容

示例：

```
标题：系统介绍
段落：本文件介绍系统架构...
图片：images/0001.png（后续由视觉模型解释）
表格：3行 × 4列
段落：注意事项...
```

**只要 AST 建好了，后面做什么都容易。**

---

# 六、为什么 AST 中只存“图片路径”？

因为：

- 图片文件很大，不适合塞进结构体
- 视觉模型需要上传文件，而不是字符串
- 图片提取、视觉理解是异步的，可以分开做
- 有利于将来做缓存（同一张图不重复花钱）
- 让文档解析（Parser）与视觉理解（Vision）互不干扰

所以：

> **图片真实保存在磁盘，AST 记录它的“地址”。**

就像你写剧本时不会把演员照片贴进去，只会写“演员：张三”。

---

# 七、完整流程（用最简单的方式解释）

把文件交给系统后，会走 4 步：

---

## **① 第一步：把文件拆成结构（由解析器完成）**

不同文件 → 解析成统一结构：

- Word → 标题、段落、表格、图片
- Excel → 表格、截图
- PDF → 文本、图片
- 图片 → 单张图片

这些结构全部写入 AST。

---

## **② 第二步：提取所有图片并保存到磁盘**

例如：

```
images/0001.png
images/0002.png
images/sheet1_table.png
```

此时 AST 里会写：

```
Image { path: "images/0001.png" }
```

还没有描述。

---

## **③ 第三步：调用视觉模型理解所有图片**

例如：

- 图片里的文字
- 图片里的表格
- UI 界面
- 图表含义
- 流程图关系
- 甚至模糊扫描件的字

视觉模型会输出：

```
这是一个登录界面，有两个输入框...
```

或：

```
| 名称 | 数量 | 单价 |
| 苹果 | 3    | 7.5  |
```

这些内容被填回 AST。

---

## **④ 第四步：把 AST 渲染成 Markdown 文档**

最终生成：

```
# 第一章 系统介绍

本文档介绍系统架构...

![图1](images/0001.png)

> 图像描述：
>   这是一个登录界面...

## 表格示例

| 名称 | 数量 | 单价 |
| 苹果 | 3 | 7.5 |
```

这就是最终交给 LLM 处理的内容。

---

# 八、为什么这种方案是最稳健的？

1. **任何格式都能处理**（Word、PDF、Excel、图片）
2. **文件质量再差也能理解**（全靠视觉模型）
3. **结构统一，便于 AI 消化**
4. **图片分开保存，可重复利用不浪费成本**
5. **全链路可缓存、可并发、可扩展**
6. **不依赖 OCR，不会因为文件质量差而失败**

这是目前业界最先进、最可靠、最通用的文档理解方案。

---

如果你愿意，我可以帮你：

- 生成这个文档的 **PPT 演示版**
- 生成一个 **两页高管汇报版（高层能一眼看懂）**
- 生成一个 **技术团队内部更详细的设计文档（架构图 + 时序图 + 模块说明）**
- 生成 **Rust 版本的完整项目 skeleton（可编译运行）**

你要哪个？
